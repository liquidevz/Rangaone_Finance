name: Docker Deploy to Domain

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  # test:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - uses: actions/setup-node@v4
  #       with:
  #         node-version: '20'
  #         cache: 'npm'
  #     - run: npm install --legacy-peer-deps
  #     - run: npm run build
  #     - run: npm run lint

  # docker-test:
  #   needs: test
  #   runs-on: ubuntu-latest
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Test Docker Build
  #       id: docker-build
  #       run: |
  #         docker build -t test-build . 2>&1 | tee build.log
  #         if [ ${PIPESTATUS[0]} -ne 0 ]; then
  #           echo "BUILD_FAILED=true" >> $GITHUB_OUTPUT
  #           echo "BUILD_LOG<<EOF" >> $GITHUB_OUTPUT
  #           cat build.log >> $GITHUB_OUTPUT
  #           echo "EOF" >> $GITHUB_OUTPUT
  #           exit 1
  #         fi
  #     - name: Send Docker Build Failure Email
  #       if: failure()
  #       uses: dawidd6/action-send-mail@v3
  #       with:
  #         server_address: smtp.gmail.com
  #         server_port: 587
  #         username: ${{ secrets.EMAIL_USERNAME }}
  #         password: ${{ secrets.EMAIL_PASSWORD }}
  #         subject: 'Docker Build Failed - ${{ github.repository }}'
  #         body: |
  #           Docker build failed for commit ${{ github.sha }}
  #           Repository: ${{ github.repository }}
  #           Branch: ${{ github.ref }}
  #           Build Error: ${{ steps.docker-build.outputs.BUILD_LOG }}
  #           View logs: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
  #         to: ${{ secrets.NOTIFICATION_EMAIL }}
  #         from: 'GitHub Actions'

  deploy:
    # needs: [test, docker-test]
    runs-on: ubuntu-latest
    steps:
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.CLOUDPANEL_SSH_KEY }}" | base64 -d > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.CLOUDPANEL_HOST }} >> ~/.ssh/known_hosts
      
      - name: Deploy with Docker
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no ${{ secrets.CLOUDPANEL_USER }}@${{ secrets.CLOUDPANEL_HOST }} << 'EOF'
          DOMAIN_PATH="/home/${{ secrets.CLOUDPANEL_USER }}/htdocs/${{ secrets.CLOUDPANEL_DOMAIN }}"
          cd $DOMAIN_PATH
          
          # Kill processes using port 3000
          sudo lsof -ti:3000 | xargs kill -9 || true
          
          # Stop containers
          docker-compose -f docker-compose.prod.yml down --remove-orphans || true
          
          # Update code
          git fetch origin && git reset --hard origin/main
          rm -rf .next node_modules/.cache
          
          # Deploy
          docker-compose -f docker-compose.prod.yml up -d --build --force-recreate
          
          # Health check
          sleep 30
          curl -f http://localhost/api/health || exit 1
          EOF
          timeout: 300s
          command_timeout: 300s
          script: |
            DOMAIN_PATH="/home/${{ secrets.CLOUDPANEL_USER }}/htdocs/${{ secrets.CLOUDPANEL_DOMAIN }}"
            cd $DOMAIN_PATH
            
            # Kill processes using port 3000
            sudo lsof -ti:3000 | xargs kill -9 || true
            
            # Stop containers
            docker-compose -f docker-compose.prod.yml down --remove-orphans || true
            
            # Update code
            git fetch origin && git reset --hard origin/main
            rm -rf .next node_modules/.cache
            
            # Deploy
            docker-compose -f docker-compose.prod.yml up -d --build --force-recreate
            
            # Health check
            sleep 30
            curl -f http://localhost/api/health || exit 1