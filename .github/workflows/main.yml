name: ðŸš€ Deploy to VPS (Production Safe)

on:
  push:
    branches: [main]
  workflow_dispatch:

concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: ðŸš€ Deploy on Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          command_timeout: 25m
          script: |
            set -Eeuo pipefail

            # =================================================================
            # Configuration
            # =================================================================
            BASE_DIR="$HOME/htdocs/www.rangaone.finance"
            APP_DIR="$BASE_DIR/Rangaone_Finance"
            IMAGE_NAME="rangaone-fe"
            CONTAINER_NAME="rangaone_fe"
            DEPLOY_LOCK="$BASE_DIR/.deploy.lock"
            HOST_PORT=3000

            mkdir -p "$BASE_DIR"

            # =================================================================
            # Deployment Lock (with stale lock cleanup)
            # =================================================================
            cleanup() {
              rm -f "$DEPLOY_LOCK"
              echo "ðŸ§¹ Cleaned up deployment lock"
            }
            trap cleanup EXIT

            if [ -f "$DEPLOY_LOCK" ]; then
              LOCK_PID=$(cat "$DEPLOY_LOCK" 2>/dev/null || echo "")
              LOCK_AGE=$(($(date +%s) - $(stat -c %Y "$DEPLOY_LOCK" 2>/dev/null || echo "0")))
              
              # If lock is older than 20 minutes, consider it stale
              if [ "$LOCK_AGE" -gt 1200 ]; then
                echo "âš ï¸  Stale lock detected (${LOCK_AGE}s old), removing..."
                rm -f "$DEPLOY_LOCK"
              else
                echo "âŒ Deployment already running (PID: $LOCK_PID, age: ${LOCK_AGE}s)"
                exit 1
              fi
            fi

            echo "$$" > "$DEPLOY_LOCK"

            # =================================================================
            # Git Operations
            # =================================================================
            echo "ðŸ“¦ Fetching latest code..."
            if [ -d "$APP_DIR/.git" ]; then
              cd "$APP_DIR"
              git fetch origin
              git reset --hard origin/main
              git clean -fd
            else
              git clone https://github.com/liquidevz/Rangaone_Finance.git "$APP_DIR"
              cd "$APP_DIR"
            fi

            TAG=$(date +%Y%m%d_%H%M%S)
            echo "ðŸ·ï¸  Build tag: $TAG"

            # =================================================================
            # Build New Image (uses .env file from repo)
            # =================================================================
            echo "ðŸ”¨ Building Docker image..."
            docker build -t "$IMAGE_NAME:$TAG" -t "$IMAGE_NAME:latest" .

            # =================================================================
            # Clean up ALL orphan containers using port 3000
            # =================================================================
            echo "ðŸ§¹ Cleaning up orphan containers..."
            
            # Find and stop any container using port 3000
            PORT_CONTAINER=$(docker ps -q --filter "publish=$HOST_PORT" 2>/dev/null || true)
            if [ -n "$PORT_CONTAINER" ]; then
              echo "   Stopping container using port $HOST_PORT: $PORT_CONTAINER"
              docker stop $PORT_CONTAINER 2>/dev/null || true
              sleep 2
            fi

            # Stop and remove any existing rangaone containers
            for container in $(docker ps -aq --filter "name=rangaone_fe" 2>/dev/null || true); do
              echo "   Removing container: $container"
              docker stop "$container" 2>/dev/null || true
              docker rm -f "$container" 2>/dev/null || true
            done

            # Double-check port is free
            sleep 2
            if docker ps -q --filter "publish=$HOST_PORT" | grep -q .; then
              echo "âŒ Port $HOST_PORT still in use after cleanup!"
              docker ps --filter "publish=$HOST_PORT"
              exit 1
            fi

            echo "âœ… Port $HOST_PORT is free"

            # =================================================================
            # Start New Container
            # =================================================================
            echo "ðŸš€ Starting new container..."
            docker run -d \
              --name "${CONTAINER_NAME}" \
              --restart unless-stopped \
              --init \
              -p "${HOST_PORT}:3000" \
              -e NODE_ENV=production \
              -e PORT=3000 \
              -e HOSTNAME=0.0.0.0 \
              --health-cmd="curl -sf http://localhost:3000/ || exit 1" \
              --health-interval=15s \
              --health-timeout=5s \
              --health-retries=5 \
              --health-start-period=40s \
              "$IMAGE_NAME:$TAG"

            # =================================================================
            # Health Check with Rollback
            # =================================================================
            echo "â³ Waiting for container to be healthy..."
            HEALTHY=false
            for i in $(seq 1 30); do
              STATUS=$(docker inspect -f '{{.State.Health.Status}}' "${CONTAINER_NAME}" 2>/dev/null || echo "starting")
              echo "   Attempt $i/30: $STATUS"
              
              if [ "$STATUS" = "healthy" ]; then
                HEALTHY=true
                break
              elif [ "$STATUS" = "unhealthy" ]; then
                echo "âŒ Container reported unhealthy"
                docker logs --tail 50 "${CONTAINER_NAME}"
                break
              fi
              sleep 5
            done

            if [ "$HEALTHY" != "true" ]; then
              echo "âŒ Container failed health check, cleaning up..."
              docker stop "${CONTAINER_NAME}" 2>/dev/null || true
              docker rm "${CONTAINER_NAME}" 2>/dev/null || true
              exit 1
            fi

            # =================================================================
            # Cleanup Old Images
            # =================================================================
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -f
            
            # Keep only last 3 tagged versions
            docker images "$IMAGE_NAME" --format "{{.Tag}}" | \
              grep -v "latest" | \
              sort -r | \
              tail -n +4 | \
              xargs -r -I {} docker rmi "$IMAGE_NAME:{}" 2>/dev/null || true

            echo ""
            echo "âœ… Deployment successful!"
            echo "   Image: $IMAGE_NAME:$TAG"
            echo "   Container: ${CONTAINER_NAME}"
            echo "   Port: $HOST_PORT"
